name: SetPwsh plugin Multiplatform Testing

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths-ignore:
      - README.md
      - LICENSE
  schedule:
      - cron: '0 7 * * *'

defaults:
  run:
    shell: pwsh

jobs:
  testing:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
    steps:
      - name: Detect latest Vim's release
        run: |
          $query = @{
            Authentication = "OAuth"
            Token          = ConvertTo-SecureString -String "${{ secrets.GITHUB_TOKEN }}" -AsPlainText
            Method         = "Get"
            Uri            = "https://api.github.com/repos/vim/vim-win32-installer/tags"
          }
          $tags = (Invoke-WebRequest @query).Content | ConvertFrom-Json -AsHashtable
          $release = $tags[0].name.TrimStart('v')

          Write-Host "Latest Vim release is $release"
          "RELEASE_VERSION=$release" | Out-File -Path $Env:GITHUB_ENV -Encoding OEM -Append

      - name: Checkout-install SetPwsh
        uses: actions/checkout@v5
        with:
          path: workplace/vim/runtime/pack/SetPwsh

      - name: Install Vim
        timeout-minutes: 5
        run: |
          $basedir = Get-Location

          pushd workplace

          # Download Vim sources
          Invoke-WebRequest -Uri https://github.com/vim/vim/archive/refs/tags/v$Env:RELEASE_VERSION.zip `
                            -OutFile vim.zip

          # Unpack Vim sources && merge SetPwsh into
          Expand-Archive -Path vim.zip -DestinationPath .
          Remove-Item vim.zip

          $vimdir = Get-Item -Path vim-*
          Move-Item -Path vim/runtime/pack/SetPwsh -Destination $vimdir/runtime/pack
          Remove-Item -Recurse -Force vim/runtime
          Move-Item -Path $vimdir/* -Destination vim
          rmdir $vimdir

          # Set helpful environment variables
          $bindir = (Get-Item -Path vim/src).FullName
          "BASEDIR=$basedir" | Out-File -Path $Env:GITHUB_ENV -Encoding OEM -Append
          "BINDIR=$bindir" | Out-File -Path $Env:GITHUB_ENV -Encoding OEM -Append
          "TESTDIR=$bindir/testdir" | Out-File -Path $Env:GITHUB_ENV -Encoding OEM -Append

          # Enter build dir
          pushd $bindir

          if ($IsWindows)
          {
            # Windows world: use precompiled binaries ... unless you need gVim ... build from sources

            # Fix Makefile to use clang-cl
            Get-Content ../runtime/pack/SetPwsh/.github/workflows/vim_mvc_clang.patch | patch -d .. -p1

            # Set up development environment
            $vswhere = "${Env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
            & $vswhere -find **/Microsoft.VisualStudio.DevShell.dll | Import-Module
            Enter-VsDevShell -SetDefaultWindowTitle -InstallPath (& $vswhere -property installationPath) `
                             -StartInPath $bindir -DevCmdArguments '/arch=x64 /host_arch=x64'

            # Decide to use cl or clang-cl
            # $CC = "clang-cl"
            $CC = "cl" # MSVC compiler seems to be faster in this case

            # Build matching environment tools (x64)
            nmake -f Make_mvc.mak CC=$CC GUI=yes VIMDLL=yes CPU=AMD64 PLATFORMS=x64 `
                                  DEBUG=yes USE_MP=NO USE_MSVCRT=yes

            # For debug builds redirect to debug binaries
            if (Test-Path -Path .\vimd.exe)
            {
              New-Item -ItemType SymbolicLink -Path .\vim.exe -Target .\vimd.exe
            }

            if (Test-Path -Path .\gvimd.exe)
            {
              New-Item -ItemType SymbolicLink -Path .\gvim.exe -Target .\gvimd.exe
            }
          }
          else
          {
            # UNIX world: build from sources
            if ($IsMacOS)
            {
              Write-Warning "MacOS lacks GUI support. Check on https://github.com/macvim-dev/macvim"
            }
            else # Ubuntu runner
            {
              do
              {
                sudo apt-get install -y libx11-dev libxt-dev libxpm-dev libgtk2.0-dev libncurses-dev
              }
              while ($LASTEXITCODE -ne 0)
            }

            ./configure --prefix=/tmp/workplace --enable-gui=auto
            # Get-Content -Path ./auto/config.mk
            # Get-Content -Path ./auto/config.log
            make
          }

          # Leaving build dir
          popd

          # local
          $Env:PATH = "$bindir$([system.io.path]::PathSeparator)$Env:PATH"
          # persistent
          $bindir | Out-File -Path $Env:GITHUB_PATH -Encoding OEM -Append

      - name: Check vim binaries
        run: |
          vim --version

          if (gcm gvim -ErrorAction SilentlyContinue)
          {
            $version = New-TemporaryFile
            gvim -c "redir! > $version | version | redir END | q!"
            Get-Content -Path $version
          }

      - name: Move tests to the test folder
        run: |
          $sourcedir = Get-Item -Path $Env:BASEDIR/workplace/vim/runtime/pack/SetPwsh/start/setpwsh/tests/
          $tests = Get-ChildItem -Path $sourcedir -Filter *.vim
          $targetdir = Get-Item -Path $Env:TESTDIR
          Copy-Item -Path $tests -Destination $targetdir

          $tests | ForEach-Object {
              Write-Host "Copied test file: $_ to $targetdir"
            }

          # Login the new test
          $MakeAll = Get-Item -Path $Env:TESTDIR/Make_all.mak
          (Get-Content -Path $MakeAll | ForEach-Object {
              $_
              if ($_ -match '^NEW_TESTS =')
              {
                $tests.BaseName | ForEach-Object { " $_ \" }
              }
              elseif ($_ -match '^NEW_TESTS_RES =')
              {
                $tests.BaseName | ForEach-Object { " $_.res \" }
              }
            }
          ) | Set-Content -Path $MakeAll

      - name: Run testing
        timeout-minutes: 5
        run: |
          # Hint plugin location to the tests
          $Env:SETPWSH_RUNTIMEDIR = "$Env:BASEDIR/workplace/vim/runtime"

          # Prepare envioronment
          if ($IsWindows)
          {
            $vswhere = "${Env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
            & $vswhere -find **/Microsoft.VisualStudio.DevShell.dll | Import-Module
            Enter-VsDevShell -SetDefaultWindowTitle -InstallPath (& $vswhere -property installationPath) `
                             -StartInPath $Env:TESTDIR -DevCmdArguments '/arch=x64 /host_arch=x64'
            $make = "nmake"
            $makefile = "/f", "Make_mvc.mak"
            $gui = ,"VIMPROG=gvim.exe"
          }
          else
          {
            cd $Env:TESTDIR
            $make = "make"
            $makefile = @()
            $gui = ,"GUI_FLAG=-g"

            if ($IsLinux)
            {
              # Start virtual display to prevent tests from hanging
              sudo apt-get install -y xvfb
              Xvfb :42 -screen 0 1024x768x24 &
              $env:DISPLAY=":42"

              Write-Host "Running a virtual display for GUI tests DISPLAY=$env:DISPLAY"
            }
          }

          Write-Host "Executing tests: $make $makefile test_plugin_setpwsh"
          & $make @makefile test_plugin_setpwsh

          if (Test-Path -Path messages)
          {
            # Get-Content -Path messages
            if ( Select-String -Path messages -Pattern 'FAILED' )
            {
              throw "Some tests failed!!!"
            }
            Remove-Item messages
          }

          # check GUI binary availability and headless environment
          if (vim --version | Select-String -Pattern 'with GTK. GUI|GUI/console')
          {
            Write-Host "Executing tests: $make $makefile $gui test_plugin_setpwsh"
            & $make @makefile @gui test_plugin_setpwsh

            if (Test-Path -Path messages)
            {
              # Get-Content -Path messages
              if ( Select-String -Path messages -Pattern 'FAILED' )
              {
                throw "Some tests failed!!!"
              }
            }
          }
          else
          {
            $msg = "⚠️  No GUI support in this vim build. Skipping GUI tests."
            Write-Warning $msg
            Write-Output "::warning::$msg"
            "> [!WARNING]", "> $msg" |
              Out-File -Path $GITHUB_STEP_SUMMARY -Encoding OEM -Append
          }

# vim: cuc sw=2 sts=2 et
